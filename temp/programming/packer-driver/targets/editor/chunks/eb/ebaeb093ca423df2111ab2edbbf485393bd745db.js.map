{"version":3,"sources":["file:///Users/yamiwang/cowboy/assets/scripts/ui/loading/HotUpdate.ts"],"names":["_decorator","Component","Asset","game","LoadingData","jsb","window","ccclass","property","HotUpdate","_updating","_canRetry","_storagePath","_am","_checkListener","_updateListener","_failCount","versionCompareHandle","onLoad","GetInstance","Data_HotUpdateEnd","fileUtils","getWritablePath","console","log","versionA","versionB","vA","split","vB","i","length","a","parseInt","b","AssetsManager","setVerifyCallback","path","asset","compressed","expectedMD5","md5","relativePath","size","checkCb","event","getEventCode","EventAssetsManager","ERROR_NO_LOCAL_MANIFEST","ERROR_DOWNLOAD_MANIFEST","ERROR_PARSE_MANIFEST","ALREADY_UP_TO_DATE","NEW_VERSION_FOUND","setEventCallback","updateCb","needRestart","failed","UPDATE_PROGRESSION","msg","getMessage","UPDATE_FINISHED","UPDATE_FAILED","ERROR_UPDATING","ERROR_DECOMPRESS","searchPaths","getSearchPaths","newPaths","getLocalManifest","JSON","stringify","Array","prototype","unshift","apply","localStorage","setItem","setSearchPaths","setTimeout","restart","retry","downloadFailedAssets","checkUpdate","getState","State","UNINITED","url","manifestUrl","nativeUrl","loadLocalManifest","isLoaded","bind","hotUpdate","update","onDestroy"],"mappings":"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","sourcesContent":["const jsb = (<any>window).jsb;\nimport { _decorator, Component, Node, Label, ProgressBar, Asset, game, sys, debug } from 'cc';\nimport { LoadingData } from './LoadingData';\n\n\n\nconst { ccclass, property } = _decorator;\n\n@ccclass('HotUpdate')\nexport class HotUpdate extends Component {\n\n    @property(Asset)\n    manifestUrl: Asset = null!;\n\n    private _updating = false;\n    private _canRetry = false;\n    private _storagePath = '';\n    private _am;\n    private _checkListener = null;\n    private _updateListener = null;\n    private _failCount = 0;\n    private versionCompareHandle: (versionA: string, versionB: string) => number = null!;\n    onLoad() \n    {\n        // Hot update is only available in Native build\n        if (!jsb) \n        {\n            LoadingData.GetInstance().Data_HotUpdateEnd = true;\n            return;\n        }\n        this._storagePath = ((jsb.fileUtils ? jsb.fileUtils.getWritablePath() : '/') + 'SY-remote-asset');\n        console.log('Storage path for remote asset : ' + this._storagePath);\n\n        // Setup your own version compare handler, versionA and B is versions in string\n        // if the return value greater than 0, versionA is greater than B,\n        // if the return value equals 0, versionA equals to B,\n        // if the return value smaller than 0, versionA is smaller than B.\n        this.versionCompareHandle = function (versionA: string, versionB: string) {\n            console.log(\"JS Custom Version Compare: version A is \" + versionA + ', version B is ' + versionB);\n            var vA = versionA.split('.');\n            var vB = versionB.split('.');\n            for (var i = 0; i < vA.length; ++i) {\n                var a = parseInt(vA[i]);\n                var b = parseInt(vB[i] || '0');\n                if (a === b) {\n                    continue;\n                }\n                else {\n                    return a - b;\n                }\n            }\n            if (vB.length > vA.length) {\n                return -1;\n            }\n            else {\n                return 0;\n            }\n        };\n\n        // Init with empty manifest url for testing custom manifest\n        this._am = new jsb.AssetsManager('', this._storagePath, this.versionCompareHandle);\n\n        //var panel = this.panel;\n        // Setup the verification callback, but we don't have md5 check function yet, so only print some message\n        // Return true if the verification passed, otherwise return false\n        this._am.setVerifyCallback(function (path: string, asset: any) {\n            // When asset is compressed, we don't need to check its md5, because zip file have been deleted.\n            var compressed = asset.compressed;\n            // Retrieve the correct md5 value.\n            var expectedMD5 = asset.md5;\n            // asset.path is relative path and path is absolute.\n            var relativePath = asset.path;\n            // The size of asset file, but this value could be absent.\n            var size = asset.size;\n            if (compressed) {\n                //panel.info.string = \"Verification passed : \" + relativePath;\n                return true;\n            }\n            else {\n                //panel.info.string = \"Verification passed : \" + relativePath + ' (' + expectedMD5 + ')';\n                return true;\n            }\n        });\n\n        //this.panel.info.string = 'Hot update is ready, please check or directly update.';\n        //this.panel.fileProgress.progress = 0;\n        //this.panel.byteProgress.progress = 0;\n    }\n\n\n    checkCb(event: any) {\n        console.log('Code: ' + event.getEventCode());\n        switch (event.getEventCode()) {\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\n                //this.panel.info.string = \"No local manifest file found, hot update skipped.\";\n                break;\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\n                //this.panel.info.string = \"Fail to download manifest file, hot update skipped.\";\n                break;\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\n                //this.panel.info.string = \"Already up to date with the latest remote version.\";\n                break;\n            case jsb.EventAssetsManager.NEW_VERSION_FOUND:\n                //this.panel.info.string = 'New version found, please try to update. (' + Math.ceil(this._am.getTotalBytes() / 1024) + 'kb)';\n                //this.panel.checkBtn.active = false;\n                //this.panel.fileProgress.progress = 0;\n                //this.panel.byteProgress.progress = 0;\n                break;\n            default:\n                return;\n        }\n\n\n        this._am.setEventCallback(null!);\n        this._checkListener = null;\n        this._updating = false;\n    }\n\n    updateCb(event: any) {\n        var needRestart = false;\n        var failed = false;\n        switch (event.getEventCode()) {\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\n                //this.panel.info.string = 'No local manifest file found, hot update skipped.';\n                failed = true;\n                break;\n            case jsb.EventAssetsManager.UPDATE_PROGRESSION:\n                //this.panel.byteProgress.progress = event.getPercent();\n                //this.panel.fileProgress.progress = event.getPercentByFile();\n\n                //this.panel.fileLabel.string = event.getDownloadedFiles() + ' / ' + event.getTotalFiles();\n                //this.panel.byteLabel.string = event.getDownloadedBytes() + ' / ' + event.getTotalBytes();\n                //console.log(this.panel.fileLabel.string, this.panel.byteLabel.string);\n                var msg = event.getMessage();\n                if (msg) {\n                    //this.panel.info.string = 'Updated file: ' + msg;\n                    // cc.log(event.getPercent()/100 + '% : ' + msg);\n                }\n                break;\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\n                //this.panel.info.string = 'Fail to download manifest file, hot update skipped.';\n                failed = true;\n                break;\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\n                //this.panel.info.string = 'Already up to date with the latest remote version.';\n                failed = true;\n                break;\n            case jsb.EventAssetsManager.UPDATE_FINISHED:\n                //this.panel.info.string = 'Update finished. ' + event.getMessage();\n                needRestart = true;\n                break;\n            case jsb.EventAssetsManager.UPDATE_FAILED:\n                //this.panel.info.string = 'Update failed. ' + event.getMessage();\n                //this.panel.retryBtn.active = true;\n                this._updating = false;\n                this._canRetry = true;\n                break;\n            case jsb.EventAssetsManager.ERROR_UPDATING:\n                //this.panel.info.string = 'Asset update error: ' + event.getAssetId() + ', ' + event.getMessage();\n                break;\n            case jsb.EventAssetsManager.ERROR_DECOMPRESS:\n                //this.panel.info.string = event.getMessage();\n                break;\n            default:\n                break;\n        }\n\n        if (failed) {\n            this._am.setEventCallback(null!);\n            this._updateListener = null;\n            this._updating = false;\n        }\n\n        if (needRestart) {\n            this._am.setEventCallback(null!);\n            this._updateListener = null;\n            // Prepend the manifest's search path\n            var searchPaths = jsb.fileUtils.getSearchPaths();\n            var newPaths = this._am.getLocalManifest().getSearchPaths();\n            console.log(JSON.stringify(newPaths));\n            Array.prototype.unshift.apply(searchPaths, newPaths);\n            // This value will be retrieved and appended to the default search path during game startup,\n            // please refer to samples/js-tests/main.js for detailed usage.\n            // !!! Re-add the search paths in main.js is very important, otherwise, new scripts won't take effect.\n            localStorage.setItem('HotUpdateSearchPaths', JSON.stringify(searchPaths));\n            jsb.fileUtils.setSearchPaths(searchPaths);\n\n            // restart game.\n            setTimeout(() => {\n                game.restart();\n            }, 1000)\n        }\n    }\n\n    retry() {\n        if (!this._updating && this._canRetry) {\n            //this.panel.retryBtn.active = false;\n            this._canRetry = false;\n\n            //this.panel.info.string = 'Retry failed Assets...';\n            this._am.downloadFailedAssets();\n        }\n    }\n\n    checkUpdate() {\n        if (this._updating) {\n            //this.panel.info.string = 'Checking or updating ...';\n            return;\n        }\n        if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\n            var url = this.manifestUrl.nativeUrl;\n            this._am.loadLocalManifest(url);\n        }\n        if (!this._am.getLocalManifest() || !this._am.getLocalManifest().isLoaded()) {\n            //this.panel.info.string = 'Failed to load local manifest ...';\n            return;\n        }\n        this._am.setEventCallback(this.checkCb.bind(this));\n\n        this._am.checkUpdate();\n        this._updating = true;\n    }\n\n    hotUpdate() {\n        if (this._am && !this._updating) {\n            this._am.setEventCallback(this.updateCb.bind(this));\n\n            if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\n                var url = this.manifestUrl.nativeUrl;\n                this._am.loadLocalManifest(url);\n            }\n\n            this._failCount = 0;\n            this._am.update();\n            //this.panel.updateBtn.active = false;\n            this._updating = true;\n        }\n    }\n\n    onDestroy() {\n        if (this._updateListener) {\n            this._am.setEventCallback(null!);\n            this._updateListener = null;\n        }\n    }\n}\n\n"]}